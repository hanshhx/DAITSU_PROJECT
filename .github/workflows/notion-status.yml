# 1. 워크플로우의 전체 식별 이름을 설정합니다. 깃허브 Actions 메뉴에 이 이름으로 표시됩니다.
name: Project Status Dashboard

# 2. 이 자동화 스크립트가 실행될 조건을 설정합니다.
on:
  # 3. 코드가 push(업로드)될 때 실행되도록 설정합니다.
  push:
    # 4. 여러 브라우저 중 오직 'main' 브랜치에 코드가 올라올 때만 작동하게 제한합니다.
    branches: [ main ]

# 5. 실제로 수행할 미션(작업)들을 정의하는 구역입니다.
jobs:
  # 6. 'build-and-report'라는 이름의 구체적인 작업 단위를 정의합니다.
  build-and-report:
    # 7. 이 작업이 실행될 가상 환경을 정합니다. 최신 리눅스(Ubuntu) 서버를 빌려 씁니다.
    runs-on: ubuntu-latest

    # 8. 작업 내부에서 순차적으로 진행될 단계들을 나열합니다.
    steps:
      # 9. 현재 깃허브 저장소에 있는 코드를 가상 서버 환경으로 복사해 옵니다. (빌드 준비)
      - name: Checkout Code
        uses: actions/checkout@v4

      # 10. 프로젝트의 빌드 상태를 검증합니다. (사용자님의 Docker 환경 기준)
      - name: Docker Build
        run: |
          echo "프로젝트 빌드 테스트 시작..."
          # docker-compose.yml 파일에 정의된 전체 서비스가 에러 없이 조립되는지 확인합니다.
          docker-compose build

      # 11. 빌드 단계가 아무 문제 없이 성공(success)했을 때 실행되는 노션 보고 단계입니다.
      - name: Update Notion Success
        # 12. 'if: success()'는 이전 단계(Docker Build)가 성공했을 때만 실행하라는 조건입니다.
        if: success()
        # [수정] 사라진 외부 액션(uses)을 제거하고, 노션 API를 직접 호출하는 스크립트(run)로 변경했습니다.
        run: |
          curl -X PATCH "https://api.notion.com/v1/pages/${{ secrets.NOTION_PAGE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data '{
              "properties": {
                "Status": { "select": { "name": "🟢 빌드 성공 (정상)" } },
                "Description": { "rich_text": [ { "text": { "content": "최근 커밋: ${{ github.event.head_commit.message }}" } } ] }
              }
            }'

      # 18. 만약 빌드 과정 중 하나라도 실패(failure)했다면 실행되는 긴급 보고 단계입니다.
      - name: Update Notion Failure
        # 19. 어느 한 단계라도 에러가 발생하면 즉시 이 단계를 실행합니다.
        if: failure()
        # [수정] 사라진 외부 액션(uses)을 제거하고, 노션 API를 직접 호출하는 스크립트(run)로 변경했습니다.
        run: |
          curl -X PATCH "https://api.notion.com/v1/pages/${{ secrets.NOTION_PAGE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data '{
              "properties": {
                "Status": { "select": { "name": "🔴 빌드 실패 (점검)" } },
                "Description": { "rich_text": [ { "text": { "content": "에러 발생 지점: ${{ github.sha }} / 개발자 확인 요망" } } ] }
              }
            }'